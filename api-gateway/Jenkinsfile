pipeline {
    agent any

    environment {
        REGISTRY = 'your-openshift-registry-url' // Use single quotes to avoid variable interpolation
        APP_NAME = 'api-gateway'
        PROJECT_NAME = 'rupesh-kallepelli-dev'
        IMAGE_TAG = 'latest'
        OPENSHIFT_SERVER = 'https://api.sandbox-m4.g2pi.p1.openshiftapps.com:6443'
        TOKEN='sha256~qQERLPLF3gtYXph-UGTcXU7QbwRPutXtIJzr5xl4tck'
    }

    stages {
//         stage('Checkout Code') {
//             steps {
//                 git branch: 'master', url: 'https://github.com/vr-here-01/vr-here-backend.git'
//             }
//         }

//         stage('Build Maven Project') {
//             steps {
//                 dir('api-gateway') {
//                     sh 'chmod +x mvnw'
//                     sh './mvnw clean package -DskipTests'
//                 }
//             }
//         }
        stage('Trigger OpenShift Build') {
            steps {
              dir('api-gateway') {
//                     withCredentials([string(credentialsId: 'openshift-token', variable: 'TOKEN')]) {
                        // Login to OpenShift
                        sh """
                        oc login --token=$TOKEN --server=$OPENSHIFT_SERVER
                        oc apply -f ./helm/buildconfig.yaml
                        oc start-build $APP_NAME --from-dir=helm/ --follow
                        """
//                     }
                }
            }
        }

        stage('Deploy to OpenShift') {
            steps {
                dir('vr-here-backend') {
                    sh """
                    oc project $PROJECT_NAME
                    oc new-app $REGISTRY/$PROJECT_NAME/$APP_NAME:$IMAGE_TAG --name=$APP_NAME || oc rollout latest $APP_NAME
                    oc expose svc/$APP_NAME
                    """
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
